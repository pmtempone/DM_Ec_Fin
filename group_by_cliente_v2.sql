/*por mes*/

SELECT numero_de_cliente, foto_mes,visa_msaldototal,
      SUM(visa_msaldototal) OVER w AS trans_total
FROM   fct_prod_premium
where  foto_mes between 201505 and 201604
WINDOW w AS (PARTITION BY numero_de_cliente
             ORDER BY fct_prod_premium
             ROWS BETWEEN 5 PRECEDING AND current row);


SELECT numero_de_cliente, foto_mes,avg(mrentabilidad) OVER w as avg_mrentabilidad,
  min(mrentabilidad) OVER w as min_mrentabilidad,
  max(mrentabilidad) OVER w as max_mrentabilidad,
  avg(mrentabilidad_annual) OVER w as avg_mrentabilidad_annual,
  min(mrentabilidad_annual) OVER w as min_mrentabilidad_annual,
  max(mrentabilidad_annual) OVER w as max_mrentabilidad_annual,
  avg(mcomisiones) OVER w as avg_mcomisiones,
  min(mcomisiones) OVER w as min_mcomisiones,
  max(mcomisiones) OVER w as max_mcomisiones,
  avg(mactivos_margen) OVER w as avg_mactivos_margen,
  min(mactivos_margen) OVER w as min_mactivos_margen,
  max(mactivos_margen) OVER w as max_mactivos_margen,
  avg(mpasivos_margen) OVER w as avg_mpasivos_margen,
  min(mpasivos_margen) OVER w as min_mpasivos_margen,
  max(mpasivos_margen) OVER w as max_mpasivos_margen,
  avg(mcuenta_corriente_nopaquete) OVER w as avg_mcuenta_corriente_nopaquete,
  min(mcuenta_corriente_nopaquete) OVER w as min_mcuenta_corriente_nopaquete,
  max(mcuenta_corriente_nopaquete) OVER w as max_mcuenta_corriente_nopaquete,
  avg(mcuenta_corriente_paquete) OVER w as avg_mcuenta_corriente_paquete,
  min(mcuenta_corriente_paquete) OVER w as min_mcuenta_corriente_paquete,
  max(mcuenta_corriente_paquete) OVER w as max_mcuenta_corriente_paquete,
  avg(mcuenta_corriente_dolares) OVER w as avg_mcuenta_corriente_dolares,
  min(mcuenta_corriente_dolares) OVER w as min_mcuenta_corriente_dolares,
  max(mcuenta_corriente_dolares) OVER w as max_mcuenta_corriente_dolares,
  avg(mcaja_ahorro_paquete) OVER w as avg_mcaja_ahorro_paquete,
  min(mcaja_ahorro_paquete) OVER w as min_mcaja_ahorro_paquete,
  max(mcaja_ahorro_paquete) OVER w as max_mcaja_ahorro_paquete,
  avg(mcaja_ahorro_nopaquete) OVER w as avg_mcaja_ahorro_nopaquete,
  min(mcaja_ahorro_nopaquete) OVER w as min_mcaja_ahorro_nopaquete,
  max(mcaja_ahorro_nopaquete) OVER w as max_mcaja_ahorro_nopaquete,
  avg(mcaja_ahorro_dolares) OVER w as avg_mcaja_ahorro_dolares,
  min(mcaja_ahorro_dolares) OVER w as min_mcaja_ahorro_dolares,
  max(mcaja_ahorro_dolares) OVER w as max_mcaja_ahorro_dolares,
  avg(mdescubierto_preacordado) OVER w as avg_mdescubierto_preacordado,
  min(mdescubierto_preacordado) OVER w as min_mdescubierto_preacordado,
  max(mdescubierto_preacordado) OVER w as max_mdescubierto_preacordado,
  avg(mcuentas_saldo) OVER w as avg_mcuentas_saldo,
  min(mcuentas_saldo) OVER w as min_mcuentas_saldo,
  max(mcuentas_saldo) OVER w as max_mcuentas_saldo,
  avg(mautoservicio) OVER w as avg_mautoservicio,
  min(mautoservicio) OVER w as min_mautoservicio,
  max(mautoservicio) OVER w as max_mautoservicio,
  avg(mtarjeta_visa_consumo) OVER w as avg_mtarjeta_visa_consumo,
  min(mtarjeta_visa_consumo) OVER w as min_mtarjeta_visa_consumo,
  max(mtarjeta_visa_consumo) OVER w as max_mtarjeta_visa_consumo,
  avg(mtarjeta_master_consumo) OVER w as avg_mtarjeta_master_consumo,
  min(mtarjeta_master_consumo) OVER w as min_mtarjeta_master_consumo,
  max(mtarjeta_master_consumo) OVER w as max_mtarjeta_master_consumo,
  avg(mprestamos_personales) OVER w as avg_mprestamos_personales,
  min(mprestamos_personales) OVER w as min_mprestamos_personales,
  max(mprestamos_personales) OVER w as max_mprestamos_personales,
  avg(mprestamos_prendarios) OVER w as avg_mprestamos_prendarios,
  min(mprestamos_prendarios) OVER w as min_mprestamos_prendarios,
  max(mprestamos_prendarios) OVER w as max_mprestamos_prendarios,
  avg(mprestamos_hipotecarios) OVER w as avg_mprestamos_hipotecarios,
  min(mprestamos_hipotecarios) OVER w as min_mprestamos_hipotecarios,
  max(mprestamos_hipotecarios) OVER w as max_mprestamos_hipotecarios,
  avg(mplazo_fijo_dolares) OVER w as avg_mplazo_fijo_dolares,
  min(mplazo_fijo_dolares) OVER w as min_mplazo_fijo_dolares,
  max(mplazo_fijo_dolares) OVER w as max_mplazo_fijo_dolares,
  avg(mplazo_fijo_pesos) OVER w as avg_mplazo_fijo_pesos,
  min(mplazo_fijo_pesos) OVER w as min_mplazo_fijo_pesos,
  max(mplazo_fijo_pesos) OVER w as max_mplazo_fijo_pesos,
  avg(mfondos_comunes_inversion_pesos) OVER w as avg_mfondos_comunes_inversion_pesos,
  min(mfondos_comunes_inversion_pesos) OVER w as min_mfondos_comunes_inversion_pesos,
  max(mfondos_comunes_inversion_pesos) OVER w as max_mfondos_comunes_inversion_pesos,
  avg(mfondos_comunes_inversion_dolares) OVER w as avg_mfondos_comunes_inversion_dolares,
  min(mfondos_comunes_inversion_dolares) OVER w as min_mfondos_comunes_inversion_dolares,
  max(mfondos_comunes_inversion_dolares) OVER w as max_mfondos_comunes_inversion_dolares,
  avg(mtitulos) OVER w as avg_mtitulos,
  min(mtitulos) OVER w as min_mtitulos,
  max(mtitulos) OVER w as max_mtitulos,
  avg(mbonos_corporativos) OVER w as avg_mbonos_corporativos,
  min(mbonos_corporativos) OVER w as min_mbonos_corporativos,
  max(mbonos_corporativos) OVER w as max_mbonos_corporativos,
  avg(mmonedas_extranjeras) OVER w as avg_mmonedas_extranjeras,
  min(mmonedas_extranjeras) OVER w as min_mmonedas_extranjeras,
  max(mmonedas_extranjeras) OVER w as max_mmonedas_extranjeras,
  avg(minversiones_otras) OVER w as avg_minversiones_otras,
  min(minversiones_otras) OVER w as min_minversiones_otras,
  max(minversiones_otras) OVER w as max_minversiones_otras,
  avg(mplan_sueldo) OVER w as avg_mplan_sueldo,
  min(mplan_sueldo) OVER w as min_mplan_sueldo,
  max(mplan_sueldo) OVER w as max_mplan_sueldo,
  avg(mplan_sueldo_manual) OVER w as avg_mplan_sueldo_manual,
  min(mplan_sueldo_manual) OVER w as min_mplan_sueldo_manual,
  max(mplan_sueldo_manual) OVER w as max_mplan_sueldo_manual,
  avg(mcuenta_debitos_automaticos) OVER w as avg_mcuenta_debitos_automaticos,
  min(mcuenta_debitos_automaticos) OVER w as min_mcuenta_debitos_automaticos,
  max(mcuenta_debitos_automaticos) OVER w as max_mcuenta_debitos_automaticos,
  avg(mttarjeta_visa_debitos_automaticos) OVER w as avg_mttarjeta_visa_debitos_automaticos,
  min(mttarjeta_visa_debitos_automaticos) OVER w as min_mttarjeta_visa_debitos_automaticos,
  max(mttarjeta_visa_debitos_automaticos) OVER w as max_mttarjeta_visa_debitos_automaticos,
  avg(mttarjeta_master_debitos_automaticos) OVER w as avg_mttarjeta_master_debitos_automaticos,
  min(mttarjeta_master_debitos_automaticos) OVER w as min_mttarjeta_master_debitos_automaticos,
  max(mttarjeta_master_debitos_automaticos) OVER w as max_mttarjeta_master_debitos_automaticos,
  avg(mpagodeservicios) OVER w as avg_mpagodeservicios,
  min(mpagodeservicios) OVER w as min_mpagodeservicios,
  max(mpagodeservicios) OVER w as max_mpagodeservicios,
  avg(mpagomiscuentas) OVER w as avg_mpagomiscuentas,
  min(mpagomiscuentas) OVER w as min_mpagomiscuentas,
  max(mpagomiscuentas) OVER w as max_mpagomiscuentas,
  avg(mcajeros_propios_descuentos) OVER w as avg_mcajeros_propios_descuentos,
  min(mcajeros_propios_descuentos) OVER w as min_mcajeros_propios_descuentos,
  max(mcajeros_propios_descuentos) OVER w as max_mcajeros_propios_descuentos,
  avg(mtarjeta_visa_descuentos) OVER w as avg_mtarjeta_visa_descuentos,
  min(mtarjeta_visa_descuentos) OVER w as min_mtarjeta_visa_descuentos,
  max(mtarjeta_visa_descuentos) OVER w as max_mtarjeta_visa_descuentos,
  avg(mtarjeta_master_descuentos) OVER w as avg_mtarjeta_master_descuentos,
  min(mtarjeta_master_descuentos) OVER w as min_mtarjeta_master_descuentos,
  max(mtarjeta_master_descuentos) OVER w as max_mtarjeta_master_descuentos,
  avg(mcuenta_descuentos) OVER w as avg_mcuenta_descuentos,
  min(mcuenta_descuentos) OVER w as min_mcuenta_descuentos,
  max(mcuenta_descuentos) OVER w as max_mcuenta_descuentos,
  avg(mcomisiones_mantenimiento) OVER w as avg_mcomisiones_mantenimiento,
  min(mcomisiones_mantenimiento) OVER w as min_mcomisiones_mantenimiento,
  max(mcomisiones_mantenimiento) OVER w as max_mcomisiones_mantenimiento,
  avg(mcomisiones_otras) OVER w as avg_mcomisiones_otras,
  min(mcomisiones_otras) OVER w as min_mcomisiones_otras,
  max(mcomisiones_otras) OVER w as max_mcomisiones_otras,
  avg(mcambio_monedas_compra) OVER w as avg_mcambio_monedas_compra,
  min(mcambio_monedas_compra) OVER w as min_mcambio_monedas_compra,
  max(mcambio_monedas_compra) OVER w as max_mcambio_monedas_compra,
  avg(mcambio_monedas_venta) OVER w as avg_mcambio_monedas_venta,
  min(mcambio_monedas_venta) OVER w as min_mcambio_monedas_venta,
  max(mcambio_monedas_venta) OVER w as max_mcambio_monedas_venta,
  avg(mtransferencias_recibidas) OVER w as avg_mtransferencias_recibidas,
  min(mtransferencias_recibidas) OVER w as min_mtransferencias_recibidas,
  max(mtransferencias_recibidas) OVER w as max_mtransferencias_recibidas,
  avg(mtransferencias_emitidas) OVER w as avg_mtransferencias_emitidas,
  min(mtransferencias_emitidas) OVER w as min_mtransferencias_emitidas,
  max(mtransferencias_emitidas) OVER w as max_mtransferencias_emitidas,
  avg(mextraccion_autoservicio) OVER w as avg_mextraccion_autoservicio,
  min(mextraccion_autoservicio) OVER w as min_mextraccion_autoservicio,
  max(mextraccion_autoservicio) OVER w as max_mextraccion_autoservicio,
  avg(mcheques_depositados) OVER w as avg_mcheques_depositados,
  min(mcheques_depositados) OVER w as min_mcheques_depositados,
  max(mcheques_depositados) OVER w as max_mcheques_depositados,
  avg(mcheques_emitidos) OVER w as avg_mcheques_emitidos,
  min(mcheques_emitidos) OVER w as min_mcheques_emitidos,
  max(mcheques_emitidos) OVER w as max_mcheques_emitidos,
  avg(mcheques_depositados_rechazados) OVER w as avg_mcheques_depositados_rechazados,
  min(mcheques_depositados_rechazados) OVER w as min_mcheques_depositados_rechazados,
  max(mcheques_depositados_rechazados) OVER w as max_mcheques_depositados_rechazados,
  avg(mcheques_emitidos_rechazados) OVER w as avg_mcheques_emitidos_rechazados,
  min(mcheques_emitidos_rechazados) OVER w as min_mcheques_emitidos_rechazados,
  max(mcheques_emitidos_rechazados) OVER w as max_mcheques_emitidos_rechazados,
  avg(chomebanking_transacciones) OVER w as avg_chomebanking_transacciones,
  min(chomebanking_transacciones) OVER w as min_chomebanking_transacciones,
  max(chomebanking_transacciones) OVER w as max_chomebanking_transacciones,
  avg(mcajeros_propio) OVER w as avg_mcajeros_propio,
  min(mcajeros_propio) OVER w as min_mcajeros_propio,
  max(mcajeros_propio) OVER w as max_mcajeros_propio,
  avg(ccajeros_propio_transacciones) OVER w as avg_ccajeros_propio_transacciones,
  min(ccajeros_propio_transacciones) OVER w as min_ccajeros_propio_transacciones,
  max(ccajeros_propio_transacciones) OVER w as max_ccajeros_propio_transacciones,
  avg(ccajeros_ajenos_transacciones) OVER w as avg_ccajeros_ajenos_transacciones,
  min(ccajeros_ajenos_transacciones) OVER w as min_ccajeros_ajenos_transacciones,
  max(ccajeros_ajenos_transacciones) OVER w as max_ccajeros_ajenos_transacciones,
  avg(mcajeros_ajenos) OVER w as avg_mcajeros_ajenos,
  min(mcajeros_ajenos) OVER w as min_mcajeros_ajenos,
  max(mcajeros_ajenos) OVER w as max_mcajeros_ajenos,
  avg(tmovimientos_ultimos90dias) OVER w as avg_tmovimientos_ultimos90dias,
  min(tmovimientos_ultimos90dias) OVER w as min_tmovimientos_ultimos90dias,
  max(tmovimientos_ultimos90dias) OVER w as max_tmovimientos_ultimos90dias,
  avg(master_mfinanciacion_limite) OVER w as avg_master_mfinanciacion_limite,
  min(master_mfinanciacion_limite) OVER w as min_master_mfinanciacion_limite,
  max(master_mfinanciacion_limite) OVER w as max_master_mfinanciacion_limite,
  avg(master_msaldototal) OVER w as avg_master_msaldototal,
  min(master_msaldototal) OVER w as min_master_msaldototal,
  max(master_msaldototal) OVER w as max_master_msaldototal,
  avg(master_msaldopesos) OVER w as avg_master_msaldopesos,
  min(master_msaldopesos) OVER w as min_master_msaldopesos,
  max(master_msaldopesos) OVER w as max_master_msaldopesos,
  avg(master_msaldodolares) OVER w as avg_master_msaldodolares,
  min(master_msaldodolares) OVER w as min_master_msaldodolares,
  max(master_msaldodolares) OVER w as max_master_msaldodolares,
  avg(master_mconsumospesos) OVER w as avg_master_mconsumospesos,
  min(master_mconsumospesos) OVER w as min_master_mconsumospesos,
  max(master_mconsumospesos) OVER w as max_master_mconsumospesos,
  avg(master_mconsumosdolares) OVER w as avg_master_mconsumosdolares,
  min(master_mconsumosdolares) OVER w as min_master_mconsumosdolares,
  max(master_mconsumosdolares) OVER w as max_master_mconsumosdolares,
  avg(master_mlimitecompra) OVER w as avg_master_mlimitecompra,
  min(master_mlimitecompra) OVER w as min_master_mlimitecompra,
  max(master_mlimitecompra) OVER w as max_master_mlimitecompra,
  avg(master_madelantopesos) OVER w as avg_master_madelantopesos,
  min(master_madelantopesos) OVER w as min_master_madelantopesos,
  max(master_madelantopesos) OVER w as max_master_madelantopesos,
  avg(master_madelantodolares) OVER w as avg_master_madelantodolares,
  min(master_madelantodolares) OVER w as min_master_madelantodolares,
  max(master_madelantodolares) OVER w as max_master_madelantodolares,
  avg(master_mpagado) OVER w as avg_master_mpagado,
  min(master_mpagado) OVER w as min_master_mpagado,
  max(master_mpagado) OVER w as max_master_mpagado,
  avg(master_mpagospesos) OVER w as avg_master_mpagospesos,
  min(master_mpagospesos) OVER w as min_master_mpagospesos,
  max(master_mpagospesos) OVER w as max_master_mpagospesos,
  avg(master_mpagosdolares) OVER w as avg_master_mpagosdolares,
  min(master_mpagosdolares) OVER w as min_master_mpagosdolares,
  max(master_mpagosdolares) OVER w as max_master_mpagosdolares,
  avg(master_mconsumototal) OVER w as avg_master_mconsumototal,
  min(master_mconsumototal) OVER w as min_master_mconsumototal,
  max(master_mconsumototal) OVER w as max_master_mconsumototal,
  avg(master_tconsumos) OVER w as avg_master_tconsumos,
  min(master_tconsumos) OVER w as min_master_tconsumos,
  max(master_tconsumos) OVER w as max_master_tconsumos,
  avg(master_mpagominimo) OVER w as avg_master_mpagominimo,
  min(master_mpagominimo) OVER w as min_master_mpagominimo,
  max(master_mpagominimo) OVER w as max_master_mpagominimo,
  avg(visa_mfinanciacion_limite) OVER w as avg_visa_mfinanciacion_limite,
  min(visa_mfinanciacion_limite) OVER w as min_visa_mfinanciacion_limite,
  max(visa_mfinanciacion_limite) OVER w as max_visa_mfinanciacion_limite,
  avg(visa_msaldototal) OVER w as avg_visa_msaldototal,
  min(visa_msaldototal) OVER w as min_visa_msaldototal,
  max(visa_msaldototal) OVER w as max_visa_msaldototal,
  avg(visa_msaldopesos) OVER w as avg_visa_msaldopesos,
  min(visa_msaldopesos) OVER w as min_visa_msaldopesos,
  max(visa_msaldopesos) OVER w as max_visa_msaldopesos,
  avg(visa_msaldodolares) OVER w as avg_visa_msaldodolares,
  min(visa_msaldodolares) OVER w as min_visa_msaldodolares,
  max(visa_msaldodolares) OVER w as max_visa_msaldodolares,
  avg(visa_mconsumospesos) OVER w as avg_visa_mconsumospesos,
  min(visa_mconsumospesos) OVER w as min_visa_mconsumospesos,
  max(visa_mconsumospesos) OVER w as max_visa_mconsumospesos,
  avg(visa_mconsumosdolares) OVER w as avg_visa_mconsumosdolares,
  min(visa_mconsumosdolares) OVER w as min_visa_mconsumosdolares,
  max(visa_mconsumosdolares) OVER w as max_visa_mconsumosdolares,
  avg(visa_madelantopesos) OVER w as avg_visa_madelantopesos,
  min(visa_madelantopesos) OVER w as min_visa_madelantopesos,
  max(visa_madelantopesos) OVER w as max_visa_madelantopesos,
  avg(visa_madelantodolares) OVER w as avg_visa_madelantodolares,
  min(visa_madelantodolares) OVER w as min_visa_madelantodolares,
  max(visa_madelantodolares) OVER w as max_visa_madelantodolares,
  avg(visa_mpagado) OVER w as avg_visa_mpagado,
  min(visa_mpagado) OVER w as min_visa_mpagado,
  max(visa_mpagado) OVER w as max_visa_mpagado,
  avg(visa_mpagospesos) OVER w as avg_visa_mpagospesos,
  min(visa_mpagospesos) OVER w as min_visa_mpagospesos,
  max(visa_mpagospesos) OVER w as max_visa_mpagospesos,
  avg(visa_mpagosdolares) OVER w as avg_visa_mpagosdolares,
  min(visa_mpagosdolares) OVER w as min_visa_mpagosdolares,
  max(visa_mpagosdolares) OVER w as max_visa_mpagosdolares,
  avg(visa_mconsumototal) OVER w as avg_visa_mconsumototal,
  min(visa_mconsumototal) OVER w as min_visa_mconsumototal,
  max(visa_mconsumototal) OVER w as max_visa_mconsumototal,
  avg(visa_tconsumos) OVER w as avg_visa_tconsumos,
  min(visa_tconsumos) OVER w as min_visa_tconsumos,
  max(visa_tconsumos) OVER w as max_visa_tconsumos,
  avg(visa_tadelantosefectivo) OVER w as avg_visa_tadelantosefectivo,
  min(visa_tadelantosefectivo) OVER w as min_visa_tadelantosefectivo,
  max(visa_tadelantosefectivo) OVER w as max_visa_tadelantosefectivo,
  avg(visa_mpagominimo) OVER w as avg_visa_mpagominimo,
  min(visa_mpagominimo) OVER w as min_visa_mpagominimo,
  max(visa_mpagominimo) OVER w as max_visa_mpagominimo
 into groups_by_cliente_v2
FROM   fct_prod_premium
--where  foto_mes between 201505 and 201604
WINDOW w AS (PARTITION BY numero_de_cliente
             ORDER BY fct_prod_premium
             ROWS BETWEEN 5 PRECEDING AND current row);
